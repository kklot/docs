# CmdStan Installation

The below instructions are meant for using CmdStan as a standalone
application. If you are using CmdStan wrappers like CmdStanPy or
CmdStanR, some of the steps outlined below are not required. Please
consult with the installation instructions of the particular wrapper
first.

## Install and check the C++ toolchain

To install and use CmdStan a modern C++ compiler (`g++` or `clang++` 
in most cases) and the `make` utility (`mingw32-make` on Windows) are
required. The minimum supported versions are 4.9.3 for `g++` and 6.0
for `clang++`. For the best experience, we recommend using at least
`g++` version 8 or `clang++` version 10.

See below for instructions on how to check and install the recommended
toolchain for different operating system.


### Linux

On most Linux installations both `g++` and the `make` utility are
typically pre-installed. To check whether they are available run:

```
g++ --version
make --version
```

If these are at least at `g++` version 4.9.3 or later and
`make` version 3.81 or later, no additional installations are
necessary. It may still be desirable to update the C++ compiler
`g++`, because later versions are faster and consume less memory.

To install the latest version of these tools (or upgrade an older
version), use the following commands or their equivalent for your
distribution:

```
sudo apt install g++
sudo apt install make
```

If you can't run `sudo`, you will need to ask your sysadmin
or cluster administrator to install these tools for you.

### MacOS

On macOS, we recommend using the toolchain that can be
installed as part of the Apple's Xcode development environment.

Download the latest version of Xcode from the [Apple developer website]((https://developer.apple.com/xcode/))
or install it [using the Mac App Store](https://itunes.apple.com/us/app/xcode/id497799835).

To test, open the Terminal application and enter:
```
clang++ --version
make --version
```

If both of the lines above run succesfully, the toolchain is
available. If you have installed XCode, but don't have `make`,
you can install the XCode command-line tools via command:
```
xcode-select --install
```

Installing and using `g++` installed from  `homebrew` or
`macports` is not recommended.

### Windows {#toolchain-windows}

On Windows, we recommend using the Rtools40 toolchain, which
is available [here](https://cran.r-project.org/bin/windows/Rtools/rtools40.html).

After installation is complete, add the following two paths
to the front of the `PATH` environment variable:
```
C:\Rtools40\usr\bin
C:\Rtools40\mingw64\bin
```

The above paths assume that Rtools40 was installed in the
default location. If a non-default location was chosen,
please update the paths accordingly.

After updating `PATH`, open a new instances of the Powershell
and run:

```
pacman -Syu mingw-w64-x86_64-make --noconfirm
```

This command will update and install any missing parts of the
toolchain. Then run the following commands 

```
Get-Command g++ | Select-Object -ExpandProperty Definition
Get-Command mingw32-make | Select-Object -ExpandProperty Definition
```

If the the commands returns the previosly added directory
`C:\Rtools40\mingw64\bin`, the toolchain was installed 
succesfully.

CmdStan can also be used with the toolchain from Rtools42
and Rtools35, but we only recommend using those if you are
using the CmdStanR wrapper and the respective version of R.

## Installation

### Installation via `conda`

CmdStan can be installed via the package management system [conda](https://docs.conda.io/en/latest/)
via the [conda-forge channel](https://conda-forge.org/). This
will install a pre-built version of CmdStan along with the required
dependencies (i.e. a C++ compiler, a version of Make, and required
libraries) detailed below under [Source installation].

One can create a new conda environment (named `stan-env`)
and install CmdStan with the following command.
```
conda create -n stan-env -c conda-forge cmdstan
```
or install it in an existing environment with
```
conda install -c conda-forge cmdstan
```

The conda installation is designed so one can use the R or Python
bindings to CmdStan seamlessly. Additionally, it provides the command
`cmdstan_model` to activate the CmdStan makefile from anywhere.
To enable either of these, ensure your environment is activated^[A special
environment, called `base`, is activated automatically by conda on startup.
Installing software directly in `base` is not recommended by conda, but may be
appropriate for some users who do not intend to use multiple environments]
with `conda activate <env>`, where `<env>` is the name of
the environment CmdStan was installed into. In the first command
above, the environment was named `stan-env`, but any name may be used
so long as you are consistent.

You can check which version of CmdStan is installed in your current
environment by running the following command.
```
conda list cmdstan
```
Finally, you can specify a different version for installation by adding `=VERSION`
to the end of the above commands.^[You can view available versions with the
command `conda search -c conda-forge cmdstan`] For example,
```
conda install -c conda-forge cmdstan=2.27.0
```

Please report conda-specific install problems directly to the
conda-forge issue tracker,
[here](https://github.com/conda-forge/cmdstan-feedstock/issues).


### Installation with the CmdStan tarball

If you are not using the `conda` package manager, we recommend installing
CmdStan from the tarballs available on the CmdStan's Github repository.

#### Downloading the CmdStan tarball

The CmdStan tarballs (`tar.gz` files) for the latest release can be found
[here](https://github.com/stan-dev/cmdstan/releases/latest).

Windows and macOS users should download the `tar.gz` file named
`cmdstan-<version>.tar.gz`.

Linux users should download the `tar.gz` file with the suffix for
their target CPU architecture. Linux users running on ARM CPU should, for
example, download the `cmdstan-<version>-arm64.tar.gz`. If running
on x86 architecture, download the tarball with no architecture suffix
(`cmdstan-<version>.tar.gz`).

After downloading the tarball, unzip it to a target folder.

#### Build CmdStan on Linux or MacOS

Run the following command inside the unzipped folder:

```
make build
```

For faster installation you can specify the `-j` flag, to use multiple
cores during building:

```
# build with 4 cores
make build -j4
```

Building can take up to a few minutes. Once the build succesfully
completes proceed to building the example below.

#### Build CmdStan on Windows

Run the following command inside the unzipped folder:

```
mingw32-make build
```

For faster installation you can specify the `-j` flag, to use multiple
cores during building:

```
# build with 4 cores
mingw32-make build -j4
```

Once the installation completes, add the following directory to the
`PATH` environment variable:

```
`<cmdstan-home>/stan/lib/stan_math/lib/tbb`
```
where `<cmdstan-home>` should be replaced with the path to the folder
with the contents of the unzipped tarball. Once the build succesfully
completes proceed to building the example below.

### Installation via cloning the CmdStan GitHub repository

The CmdStan repo contains just the `cmdstan` module - the Stan inference
engine algorithms and Stan math library functions are specified as
Git [submodules](https://git-scm.com/book/en/v2/Git-Tools-Submodules)
and stored in the GitHub repositories [stan](https://github.com/stan-dev/stan) and [math](https://github.com/stan-dev/math),
respectively.

By cloning the CmdStan repository with argument `--recursive`,
Git automatically initializes and updates each submodule in the repository,
including nested submodules if any of the submodules
in the repository have submodules themselves.

The following sequence of commands will check out the current
CmdStan `develop` branch on GitHub and assemble and build the
command line interface and supporting libraries:

```
> git clone https://github.com/stan-dev/cmdstan.git --recursive
> cd cmdstan
> make build    # on Windows use mingw32-make
```

Please check the build steps outlined for installation from a
release tarball for more details.

The resulting set of directories should have the same structure as the release:

- directory `cmdstan/stan` contains the sub-module `stan` (https://github.com/stan-dev/stan)
- directory `cmdstan/stan/lib/stan_math` contains the sub-module `math` (https://github.com/stan-dev/math)

## Running the Bernoulli example

Upon succesfully installing CmdStan with any of the above approaches,
compile and run the example model as outlined below.

On Linux and MacOS run the following commands:
```
make examples/bernoulli/bernoulli
./examples/bernoulli/bernoulli sample data file=examples/bernoulli/bernoulli.data.json
```

On Windows run:
```
mingw32-make examples/bernoulli/bernoulli.exe
./examples/bernoulli/bernoulli.exe sample data file=examples/bernoulli/bernoulli.data.json
```

If these commands run without issues, the installation was done succesfully.

## Rebuilding CmdStan

If for any reason, rebuilding CmdStan is required, it can be performed by cleaning
and building the installation. On Linux and macOS this can be done by running:

```
make clean-all
make build
```

On Windows run:

```
mingw32-make clean-all
mingw32-make build
```

## Common problems

This section contains solutions to problems reported on https://discourse.mc-stan.org.

**Compiler error message about PCH file**

To speed up compilation, the Stan makefile pre-compiles parts of the core Stan library.
If these pre-compiled files are out of sync with the compiled model, the compiler will complain, e.g.:

```
error: PCH file uses an older PCH format that is no longer supported
```

In this case, clean and rebuild CmdStan, as shown in the previous section.


**Windows: 'mingw32-make' is not recognised**

If the C++ toolchain has been installed but not properly registered,
then the call to `mingw32-make` will result in error message:
```
'mingw32-make' is not recognised as an internal or external command
```
To fix this issue, make sure to follow instructions on [installing the C++
toolchain on Windows](#toolchain-windows).

**Windows: 'g++' or 'cut' is not recognized**

The CmdStan makefile uses a few shell utilities which might not be present in Windows,
resulting in the error message:
```
'cut' is not recognized as an internal or external command, operable program or batch file.
```

To fix this issue, make sure to follow instructions on [installing the C++
toolchain on Windows](#toolchain-windows).
